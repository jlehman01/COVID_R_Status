---
title: "COVID Testing &  Guidance for Schools"
subtitle: "CDC, PA Department of Education, and CHOP Recommendations Based on Current COVID Indicators in Philadelphia."
output:
  rmarkdown::html_document:
    theme: flatly
output_dir: "docs"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(jsonlite)
library(tidyr)
library(zoo)
library(plotly)
library(kableExtra)
library(data.table)
library(lubridate)
library(plotly)

options(scipen = 999) 
```

The purpose of this website is to apply COVID-19 school recommendations from trusted sources to the current situation in Philadelphia. To this end, recommended measures and thresholds from the following publications are calculated, and published recommendations based on these indicators are presented.

* [Centers for Disease Control and Prevention (CDC)](https://www.cdc.gov/coronavirus/2019-ncov/community/schools-childcare/indicators.html#thresholds)
* [Pennsylvania Department of Education (PA DOE) Instructional Model Recommendations](https://www.education.pa.gov/Schools/safeschools/emergencyplanning/COVID-19/SchoolReopeningGuidance/ReopeningPreKto12/Pages/DeterminingInstructionalModels.aspx)
* [Children's Hospital of Philadelphia (CHOP) Quick Reference Guide for Reopening Schools](https://policylab.chop.edu/sites/default/files/pdf/publications/PolicyLab-Quick-Reference-Guide-For-Reopening-Schools.pdf)

Data notes:

* Testing data from [OpenDataPhilly](https://www.opendataphilly.org/dataset/covid-cases). 
* 3 most recent days removed from analysis, as Philadelphai city notes recent days are incomplete.
* The [specific dataset](https://www.opendataphilly.org/dataset/covid-cases/resource/85fead1a-0ec3-4856-98a9-27ba4fa941ee) used to populate this page appears to report test results based on the day they were taken, and not on the day the results were officially reported.

*Notice: This website is a personal project and is not intended for public use. Please do not use this site as a source for reliable information on COVID.*

```{r}

phila_city_pop <- 1584064

phila_pop_under_20 <- 1584064*.24

url <- URLencode("https://phl.carto.com/api/v2/sql?q=SELECT * FROM covid_cases_by_date")

data_import <- fromJSON(url)

test_data <- data_import$rows %>% 
  select(-etl_timestamp, -the_geom_webmercator, -the_geom, -cartodb_id) %>% 
  mutate(collection_date = as.Date(collection_date,'%Y-%m-%d')) %>% 
  pivot_wider(collection_date, names_from = "test_result", values_from = "count") %>% 
  complete(collection_date = full_seq(collection_date, period = 1), fill = list(negative = 0, positive = 0)) 

#remove 2 most recent days, as data is consistently low
test_data <- head(test_data, -3)

#add metrics
test_data <- test_data %>% 
  mutate(cum_rolling_positive_7 = 
           rollapplyr(positive, width = 7, FUN = sum, partial = TRUE)) %>% 
  mutate(cum_rolling_positive_14 = 
           rollapplyr(positive, width = 14, FUN = sum, partial = TRUE)) %>% 
  mutate(cum_rolling_negative_7 = 
           rollapplyr(negative, width = 7, FUN = sum, partial = TRUE)) %>% 
  mutate(cum_rolling_negative_14 = 
           rollapplyr(negative, width = 14, FUN = sum, partial = TRUE)) %>% 
  mutate(cum_rollign_pct_pos_7 = cum_rolling_positive_7 / cum_rolling_negative_7, 
         cum_rollign_pct_pos_14 = cum_rolling_positive_14 / cum_rolling_negative_14,
         cdc_new_cases = cum_rolling_positive_14 /phila_city_pop*100000,
         pa_new_cases = cum_rolling_positive_7 / phila_city_pop*100000) %>%
  mutate(pct_change_new_cases_from_previous_week = ((cum_rolling_positive_7 - lag(cum_rolling_positive_7, n = 7)) / lag(cum_rolling_positive_7, n = 7))*100) %>% 
  arrange(desc(collection_date)) %>% 
  filter(collection_date > as.Date("2020-06-01"))


```



```{r cdc guidance summary, results = "asis"}

test_data <- test_data %>% 
  mutate(cdc_pct_positive_guidance = case_when(
    cum_rollign_pct_pos_14 < 0.03 ~ "Lowest risk of transmission in schools (1/5)",
    cum_rollign_pct_pos_14 >= 0.03 & cum_rollign_pct_pos_14 < 0.05 ~ 
      "Lower risk of transmission in schools (2/5)",
    cum_rollign_pct_pos_14 >= 0.05 & cum_rollign_pct_pos_14 < 0.08 ~ 
      "Moderate risk of transmission in schools (3/5)",
    cum_rollign_pct_pos_14 >= 0.08 & cum_rollign_pct_pos_14 <= 0.10 ~ 
      "Higher risk of transmission in schools (4/5)",
    cum_rollign_pct_pos_14 > 0.10 ~ 
      "Highest risk of transmission in schools (5/5)",),
    
    cdc_new_case_guidance = case_when(
    cdc_new_cases < 5 ~ "Lowest risk of transmission in schools (1/5)",
    cdc_new_cases >= 5 & cdc_new_cases < 20 ~ 
      "Lower risk of transmission in schools (2/5)",
    cdc_new_cases >= 20 & cdc_new_cases < 50 ~ 
      "Moderate risk of transmission in schools (3/5)",
    cdc_new_cases >= 50 & cdc_new_cases <= 200 ~ 
      "Higher risk of transmission in schools (4/5)",
    cdc_new_cases > 200 ~ 
      "Highest risk of transmission in schools (5/5)",)
    )

```


```{r}
#3 add PA DOE guidance

test_data <- test_data %>% 
  mutate(pa_doe_transmission_risk = case_when(
    pa_new_cases < 10 &  cum_rollign_pct_pos_7 < 0.05~ "Low",
    pa_new_cases < 100 | cum_rollign_pct_pos_7 < 0.10 ~ "Moderate",
    pa_new_cases >= 100 | cum_rollign_pct_pos_7 >= 0.10 ~ "High"),
    pa_doe_guidance = case_when(
    pa_new_cases < 10 &  cum_rollign_pct_pos_7 < 0.05~ "Full in-person Model OR Blended Learning Model",
    pa_new_cases < 100 | cum_rollign_pct_pos_7 < 0.10 ~ "Blended Learning Model OR Full Remote Learning Model",
    pa_new_cases >= 100 | cum_rollign_pct_pos_7 >= 0.10 ~ "Full Remote Learning Model")
    )

```


```{r}
#add CHOP guidance

test_data <- test_data %>% 
  mutate(chop_guidance = case_when(
    pa_new_cases < 10 &  cum_rollign_pct_pos_7 < 0.05~ 
      "Reopen schools previously online for full in-class or hybrid instruction in compliance with state and district guidance",
    pa_new_cases < 35 | cum_rollign_pct_pos_7 < 0.05 ~ 
      "Consider incremental reopening strategy returning special needs and or elementary age children to the classroom",
    cum_rollign_pct_pos_7 <= 0.09 ~ 
      "If already resumed in-class instruction, cautiously continue with plan, provided there is no evidence of transmission among students in the classroom, activity groups, or teachers/staff; actively monitor county rates with public health department",
    cum_rollign_pct_pos_7 >0.09 ~ "Revert to online schooling only"),
    pa_doe_guidance = case_when(
    pa_new_cases < 10 &  cum_rollign_pct_pos_7 < 0.05~ 
      "Full in-person Model OR Blended Learning Model",
    pa_new_cases < 100 | cum_rollign_pct_pos_7 < 0.10 ~ 
      "Blended Learning Model OR Full Remote Learning Model",
    pa_new_cases >= 100 | cum_rollign_pct_pos_7 >= 0.10 ~ 
      "Full Remote Learning Model")
    )



```

# Recent Guidance

## CDC

```{r recent guidance CDC}

cdc_guidance <- filter(test_data[1:10,] %>% select(collection_date, cdc_pct_positive_guidance, cdc_new_case_guidance))

kbl(cdc_guidance, col.names = c("Date", "CDC % Positive Guidance", "CDC New Case Guidance")) %>% kable_styling(bootstrap_options = "striped", full_width = T, position = "left")

```

## PA Department of Education

```{r recent guidance PADOE}

cdc_guidance <- filter(test_data[1:10,] %>% select(collection_date, pa_doe_transmission_risk, pa_doe_guidance))

kbl(cdc_guidance, col.names = c("Date", "CPA DOE Risk", "Pa DOE Guidance")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = T, position = "left")
```

## Children's Hospital of Philadelphia

```{r recent guidance CHOP}

cdc_guidance <- filter(test_data[1:10,] %>% select(collection_date, chop_guidance, chop_guidance))

kbl(cdc_guidance, col.names = c("Date", "CHOP Guidance")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = T, position = "left") %>% 
  column_spec(2, width_max = "5in")

```
*Note: CHOP recommendations for reopening are contingent on stable or declining new case trends. Please refer to their [publication](https://policylab.chop.edu/sites/default/files/pdf/publications/PolicyLab-Quick-Reference-Guide-For-Reopening-Schools.pdf) for more information.

# Charts

## Percent Positive Guidance

The following plots show guidance from CDC, PA Department of Education, and CHOP that are based on the percentage of all tests that are positive. CDC guidance is based on tests over the past 14 days. PA DOE and CHOP guidance is based on testing over the past 7 days.

```{r plot number of new cases and percent positive}

cdc_pct_positive <- ggplot(data=test_data, aes(x=collection_date, y=cum_rollign_pct_pos_14, group=1)) +
  geom_line() +
  xlab("") +
  ylab("% Positive ") +
  ggtitle("Percent Positive Guidance from CDC, PA DOE, and CHOP") +
  geom_hline(yintercept=.03, linetype="dashed", 
                color = "#008080", size=0.5) +
        annotate(geom="text",x=as.Date("2020-08-05"), y=.04, label="Lower risk (CDC)", color = "#008080", size=3) +
  geom_hline(yintercept=0.05, linetype="dashed", 
                color = "#b4c8a8", size=0.5) +
      annotate(geom="text",x=as.Date("2020-08-05"), y=.06, label="Moderate risk (CDC)", color = "#b4c8a8", size=3) +
  geom_hline(yintercept=0.08, linetype="dashed", 
                color = "#edbb8a", size=0.5) +
    annotate(geom="text",x=as.Date("2020-08-05"), y=.09, label="Higher risk (CDC)", color = "#edbb8a", size=3) +
  geom_hline(yintercept=0.10, linetype="dashed", 
                color = "#ca562c", size=0.5) +
    annotate(geom="text",x=as.Date("2020-08-05"), y=.11, label="Highest Risk (CDC)", color = "#ca562c", size=3) +
  theme_bw()


pa_pct_positive_padoe <- ggplot(data=test_data, aes(x=collection_date, y=cum_rollign_pct_pos_7, group=1)) +
  geom_line() +
  xlab("") +
  ylab("% Postiive ") +
  geom_hline(yintercept=.05, linetype="dashed", color = "#edbb8a", size=0.5) +
  annotate(geom="text",x=as.Date("2020-08-05"), y=.06, label="Moderate (PA DEP)", color = "#edbb8a", size=3) +
  geom_hline(yintercept=.1, linetype="dashed",color = "#ca562c", size=0.5) +
  annotate(geom="text",x=as.Date("2020-08-05"), y=.11, label="Substantial (PA DEP)", color = "#ca562c", size=3) +
  theme_bw()


pa_pct_positive_chop <- ggplot(data=test_data, aes(x=collection_date, y=cum_rollign_pct_pos_7, group=1)) +
  geom_line() +
  xlab("") +
  ylab("% Postiive") +
  geom_hline(yintercept=.05, linetype="dashed", color = "#edbb8a", size=0.5) +
  annotate(geom="text",x=as.Date("2020-08-05"), y=.06, label="Actively Monitor (CHOP)", color = "#edbb8a", size=3) +
  geom_hline(yintercept=.09, linetype="dashed",color = "#ca562c", size=0.5) +
  annotate(geom="text",x=as.Date("2020-08-05"), y=.11, label="Revert to Online (CHOP)", color = "#ca562c", size=3) +
  theme_bw()


subplot(cdc_pct_positive, pa_pct_positive_padoe, pa_pct_positive_chop, nrows=1, shareX = TRUE, shareY = TRUE)

```

## New Case Guidance

The following plots show guidance from CDC, PA Department of Education, and CHOP that are based on new cases. CDC guidance is based on new cases per 100,000 residents over the past 14 days. PA DOE and CHOP guidance is based on new cases per 100,000 residents over the past 7 days.

```{r new case risk}
cdc_new_cases <- ggplot(data=test_data, aes(x=collection_date, y=cdc_new_cases, group=1)) +
  geom_line() +
  xlab("") +
  ylab("New Cases/100,000") +
  ggtitle("New Case Guidance from CDC, PA DOE, and CHOP") +
  geom_hline(yintercept=5, linetype="dashed", 
                color = "#008080", size=0.5) +
  annotate(geom="text",x=as.Date("2020-08-05"), y=10, label="Lower risk (CDC)", color = "#008080", size=3) +
  geom_hline(yintercept=20, linetype="dashed", 
                color = "#b4c8a8", size=0.5) +
       annotate(geom="text",x=as.Date("2020-08-05"), y=25, label="Moderate risk (CDC)", color = "#b4c8a8", size=3) +
  geom_hline(yintercept=50, linetype="dashed", 
                color = "#edbb8a", size=0.5) +
      annotate(geom="text",x=as.Date("2020-08-05"), y=55, label="Higher risk (CDC)", color = "#edbb8a", size=3) +
  geom_hline(yintercept=200, linetype="dashed", 
                color = "#ca562c", size=0.5) +
      annotate(geom="text",x=as.Date("2020-08-05"), y=205, label="Highest Risk (CDC)", color = "#ca562c", size=3) +
  theme_bw()


pa_new_cases <- ggplot(data=test_data, aes(x=collection_date, y=pa_new_cases, group=1)) +
  geom_line() +
  xlab("") +
  ylab("% Postiive ") +
  ylab("New Cases/100,000") +
  geom_hline(yintercept=10, linetype="dashed", 
                color = "#edbb8a", size=0.5) +
    annotate(geom="text",x=as.Date("2020-08-05"), y=15, label="Moderate (PA DEP)", color = "#edbb8a", size=3) +
  geom_hline(yintercept=100, linetype="dashed", 
                color = "#ca562c", size=0.5) +
      annotate(geom="text",x=as.Date("2020-08-05"), y=105, label="Substantial (PA DEP)", color = "#ca562c", size=3) +
  theme_bw()

chop_new_cases <- ggplot(data=test_data, aes(x=collection_date, y=pa_new_cases, group=1)) +
  geom_line() +
  xlab("") +
  ylab("% Postiive ") +
  ylab("New Cases/100,000") +
  geom_hline(yintercept=10, linetype="dashed", 
                color = "#b4c8a8", size=0.5) +
    annotate(geom="text",x=as.Date("2020-08-05"), y=15, label="Consider incremental reopening (CHOP)", color = "#b4c8a8", size=3) +
  geom_hline(yintercept=35, linetype="dashed", 
                color = "#edbb8a", size=0.5) +
      annotate(geom="text",x=as.Date("2020-08-05"), y=40, label="Actively monitor (CHOP)", color = "#edbb8a", size=3) +
  theme_bw()



subplot(cdc_new_cases, pa_new_cases, chop_new_cases, nrows=1, shareX = TRUE, shareY = TRUE)

```

## New Case Trend

CHOP's school reopening recommendations are contingent on "stable or declining weekly case incidence." The following plot shows the percentage change in the number of new cases from the past 7 days compared to the previous 7 days. This indicator directly informs whether cases are stable or declining.

```{r plot percent change in new weekly cases from previous week}

test_data_filtered <- test_data %>% 
  mutate(color = ifelse(pct_change_new_cases_from_previous_week>0, "increase", "decrease")) %>% filter(collection_date > as.Date("2020-05-1",'%Y-%m-%d'))
 
  pct_change <- ggplot(data=test_data_filtered, aes(x=collection_date, y=pct_change_new_cases_from_previous_week)) + 
  geom_segment(aes(x=collection_date, 
                   xend=collection_date, 
                   y=0, 
                   yend=pct_change_new_cases_from_previous_week,
                   color = color)) + 
  labs(title="Change in New Cases from Previous Week") +
    xlab("") +
    ylab("% Change") +
  theme_bw()+ theme(legend.position="none")
  
ggplotly(pct_change)

```





