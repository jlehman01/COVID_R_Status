---
title: "COVID Hospitalizations"
subtitle: "Hospitalizations by Type and Available ICU Beds for Lancaster and Philadelphia Counties"
output:
  rmarkdown::html_document:
    theme: flatly
output_dir: "docs"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(jsonlite)
library(tidyr)
library(zoo)
library(plotly)
library(kableExtra)
library(data.table)
library(lubridate)
library(plotly)

options(scipen = 999) 
```

*Notice: This website is a personal project and is not intended for public use. Please do not use this site as a source for reliable information on COVID.*

```{r read in philadelphia}

url <- URLencode("https://data.pa.gov/resource/kayn-sjhx.json?county=Philadelphia")

data_import <- fromJSON(url)

data_import$date <- as_datetime(data_import$date)

colnames <- colnames(data_import[3:37])

data_longer <- pivot_longer(data_import, cols = colnames, 
                            names_to = "indicator", values_to = "number") %>%
  mutate(number = as.numeric(number))

```


```{r plot philadelphia}

philadelphia <- data_longer %>% 
  filter(county == "Philadelphia", 
         indicator %in% c("date", "covid_patients", "covid_vents", 
                          "covid_patients_adult_in_icu", "icu_avail")) %>% 
  drop_na()

ggplotly(ggplot(philadelphia, aes(x = date, y = number)) + 
  geom_line(aes(color = indicator), size = 1) +
  ggtitle("Philadelphia COVID Hospitalizations") +
  theme_minimal())
```

```{r read in lancaster}

url <- URLencode("https://data.pa.gov/resource/kayn-sjhx.json?county=Lancaster")

data_import <- fromJSON(url)

data_import$date <- as_datetime(data_import$date)

colnames <- colnames(data_import[3:36])

data_longer <- pivot_longer(data_import, cols = colnames, 
                            names_to = "indicator", values_to = "number") %>%
  mutate(number = as.numeric(number))


           
```

```{r plot lancaster}

lancaster <- data_longer %>% 
  filter(county == "Lancaster", 
         indicator %in% c("date", "covid_patients", "covid_vents", 
                          "covid_patients_adult_in_icu", "icu_avail")) %>% 
  drop_na()

ggplotly(ggplot(lancaster, aes(x = date, y = number)) + 
  geom_line(aes(color = indicator), size = 1) +
  ggtitle("Lancaster COVID Hospitalizations") +
  theme_minimal())
```

```{r pediatric, eval=FALSE}

# Stack daily files within folder and keep distinct records
build_historical_dataset <- function(data_folder) {
  list.files(path = data_folder, full.names = TRUE) %>%
    map_dfr(read_csv) %>%
    distinct() # duplicates occur when there is an extract but no data update
}

# Cases by test result and reporting dates
cases_by_age <- build_historical_dataset("/Users/joellehman/Documents/GitHub/covid19-philadelphia/cases_by_age/")

cases_under_20_complete <- cases_by_age %>% 
  filter(age == "<20") %>% 
  mutate(date = as.Date(etl_timestamp)) %>% 
   complete(date = full_seq(date, period = 1), fill = list(count = NA, age = "<20"))

cases_under_20_complete$count_imputed <- na.approx(cases_under_20_complete$count, maxgap = 7)

cases_under_20_complete <- cases_under_20_complete %>% 
  mutate(new_cases = count_imputed - lag(count_imputed, n=1))

 
  pct_change <- ggplot(data=cases_under_20_complete, aes(x=date, y=new_cases)) + 
  geom_segment(aes(x=date, 
                   xend=date, 
                   y=0, 
                   yend=new_cases)) + 
   geom_line(aes(y=rollmean(new_cases, 7, na.pad=TRUE))) +
  labs(title="New Cases (<20)") +
    xlab("") +
    ylab("New Cases") +
  theme_bw() + theme(legend.position="none")
  
  

  
ggplotly(pct_change)



```

