---
title: "COVID General Indicators"
output:
  rmarkdown::html_document:
    theme: flatly
output_dir: "docs"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(jsonlite)
library(tidyr)
library(zoo)
library(plotly)
library(kableExtra)
library(data.table)
library(lubridate)
library(plotly)
library(ggpmisc)

options(scipen = 999)

options(timeout= 4000000) 
```

*Notice: This website is a personal project and is not intended for public use. Please do not use this site as a source for reliable information on COVID.*

Data notes: 

* Testing data from [OpenDataPhilly](https://www.opendataphilly.org/dataset/covid-cases).
* Hospital data from [PA Dpt. of Health](https://data.pa.gov/Health/Coronavirus-COVID-19-Department-of-Health-Website/98pd-gs2r).
* Testing data on this page is built by assembling daily reports by subset (zip code, age), which appear to classify dates based on when the results were reported (as opposed to when the test was taken). The city data portal does not provide time series data by subset (zip code, age). Numbers on the [School Guidance](https://jlehman01.github.io/COVID_R_Status/covid_status.html) page will vary slightly from the data on this due to this discrepancy in date reporting, and will be more accurate.


```{r, echo=FALSE, results = 'asis'}

today <- today()
cat("Site last updated ", format(today, format= "%B %d %Y"))
```


```{r read in philadelphia}

url <- URLencode("https://data.pa.gov/resource/kayn-sjhx.json?county=Philadelphia")

data_import <- fromJSON(url) %>% 
  select(date, covid_patients, covid_vents, icu_avail)

data_import$date <- as_datetime(data_import$date)

colnames <- colnames(data_import[2:4])

data_longer <- pivot_longer(data_import, cols = colnames, 
                            names_to = "indicator", values_to = "number") %>%
  mutate(number = as.numeric(number))

```


```{r plot philadelphia}

philadelphia <- data_longer %>% 
  filter(indicator %in% c("date", "covid_patients", "covid_vents", 
                          "icu_avail"))

ggplotly(ggplot(philadelphia, aes(x = date, y = number)) + 
  geom_line(aes(color = indicator)) +
  ggtitle("Philadelphia COVID Hospitalizations") +
  theme_minimal())
```

```{r read in lancaster}

url <- URLencode("https://data.pa.gov/resource/kayn-sjhx.json?county=Lancaster")

data_import <- fromJSON(url) %>% 
  select(date, covid_patients, covid_vents, icu_avail)

data_import$date <- as_datetime(data_import$date)

colnames <- colnames(data_import[2:4])

data_longer <- pivot_longer(data_import, cols = colnames, 
                            names_to = "indicator", values_to = "number") %>%
  mutate(number = as.numeric(number))


           
```

```{r plot lancaster}

lancaster <- data_longer %>% 
  filter(indicator %in% c("date", "covid_patients", "covid_vents", 
                          "icu_avail")) %>% 
  drop_na()

ggplotly(ggplot(lancaster, aes(x = date, y = number)) + 
  geom_line(aes(color = indicator)) +
  ggtitle("Lancaster COVID Hospitalizations") +
  theme_minimal())
```

```{r new pediatric cases, eval=TRUE}

download.file(url = "https://github.com/ambientpointcorp/covid19-philadelphia/archive/master.zip", destfile = "covid_archive_github.zip")

unzip(zipfile = "covid_archive_github.zip", overwrite = T)

# Stack daily files within folder and keep distinct records
build_historical_dataset <- function(data_folder) {
  list.files(path = data_folder, full.names = TRUE) %>%
    map_dfr(read_csv) %>%
    distinct() # duplicates occur when there is an extract but no data update
}

# Cases by test result and reporting dates
cases_by_age <- build_historical_dataset("covid19-philadelphia-master/cases_by_age/")

cases_under_20_complete <- cases_by_age %>% 
  filter(age == "<20") %>% 
  mutate(date = as.Date(etl_timestamp)) %>% 
   complete(date = full_seq(date, period = 1), fill = list(count = NA, age = "<20"))

cases_under_20_complete$count_imputed <- na.approx(cases_under_20_complete$count, maxgap = 7)

cases_under_20_complete <- cases_under_20_complete %>% 
  mutate(new_cases = count_imputed - lag(count_imputed, n=1),
         new_cases_7_mean = rollmean(new_cases, 7, align = "right", na.pad=TRUE)
         )

    covid_cases_under_20 <- ggplot(data = cases_under_20_complete, aes(x=date,
             y=new_cases)) +
  geom_col(fill="pink")+
  geom_line(aes(y = new_cases_7_mean), 
            color = "red", 
            size = .75)+
  labs(title="New Philadelphia COVID Cases for < 20 Population",
       y="New Cases / Day",
       x="") +
      theme_bw()
  
ggplotly(covid_cases_under_20)


```


````{r ped hospitilizations}

# Cases by test result and reporting dates
hospitilizations_by_age <- build_historical_dataset("covid19-philadelphia-master/hospitalizations_by_age/")

hospitilizations_under_20_complete <- hospitilizations_by_age %>% 
  filter(age == "<20") %>% 
  mutate(date = as.Date(etl_timestamp)) %>% 
   complete(date = full_seq(date, period = 1), fill = list(Yes = NA, age = "<20"))

#hospitilizations_under_20_complete$Yes_imputed <- #na.approx(hospitilizations_under_20_complete$Yes, maxgap = 7)

hospitilizations_under_20_complete <- hospitilizations_under_20_complete %>% 
  mutate(new_hospitilizations = Yes - lag(Yes, n=1),
         new_hospitilizations_7_mean = rollmean(new_hospitilizations, 7, align = "right", na.pad=TRUE)
         )

covid_hospitilizations_under_20 <- ggplot(data = hospitilizations_under_20_complete, aes(x=date,
             y=new_hospitilizations)) +
  geom_col(fill="pink")+
  labs(title="New Philadelphia COVID Hospitalizations for < 20 Population",
       y="New Hospitalizations",
       x="") +
      theme_bw()
  
ggplotly(covid_hospitilizations_under_20)

```

````{r percent positive by zip code}

pct_positive_by_zip <- build_historical_dataset("covid19-philadelphia-master/cases_by_zipcode/")

pct_positive_by_zip_complete <- pct_positive_by_zip %>% 
  mutate(date = as.Date(etl_timestamp)) %>% 
  group_by(zip_code) %>% 
 filter(zip_code == 19143 | zip_code == 19104 | zip_code == 19103) %>%
  drop_na(POS) %>% 
  drop_na(NEG) %>% 
  complete(date = full_seq(date, period = 1), fill = list(NEG = NA, POS = NA)) %>%
  mutate(POS_imputed = na.approx(POS),
         NEG_imputed = na.approx(NEG),
         POS_new = POS_imputed - lag(POS_imputed, n=1),
         NEG_new = NEG_imputed - lag(NEG_imputed, n=1),
         POS_new_7_mean = rollmean(POS_new, 7, align = "right", na.pad=TRUE),
         PCT_positive_day = POS_new/NEG_new,
         POS_7_day_cum = rollapplyr(POS_new, width = 7, FUN = sum, partial = TRUE),
         POS_14_day_cum = rollapplyr(POS_new, width = 14, FUN = sum, partial = TRUE),
         NEG_7_day_cum = rollapplyr(NEG_new, width = 7, FUN = sum, partial = TRUE),
         PCT_postive_7_day = POS_7_day_cum/NEG_7_day_cum,
         POS_14_day_per_100000 = case_when(
           zip_code == 19143 ~ POS_14_day_cum / 64849*100000,
           zip_code == 19104 ~ POS_14_day_cum / 51808*100000,
           zip_code == 19103 ~ POS_14_day_cum / 22940*100000))

ggplotly(ggplot(pct_positive_by_zip_complete, aes(x = date, y = PCT_postive_7_day)) + 
  geom_line(aes(color = as.character(zip_code))) +
  xlab("") +
  ylab("Portion Positive (7-day rolling average)") +
  ggtitle("Percent Positive by Phila Zip") +
  geom_hline(yintercept=.03, linetype="dashed", 
                color = "#008080", size=0.5) +
        annotate(geom="text",x=as.Date("2020-08-05"), y=.04, label="Lower risk (CDC)", color = "#008080", size=3) +
  geom_hline(yintercept=0.05, linetype="dashed", 
                color = "#b4c8a8", size=0.5) +
      annotate(geom="text",x=as.Date("2020-08-05"), y=.06, label="Moderate risk (CDC)", color = "#b4c8a8", size=3) +
  geom_hline(yintercept=0.08, linetype="dashed", 
                color = "#edbb8a", size=0.5) +
    annotate(geom="text",x=as.Date("2020-08-05"), y=.09, label="Higher risk (CDC)", color = "#edbb8a", size=3) +
  geom_hline(yintercept=0.10, linetype="dashed", 
                color = "#ca562c", size=0.5) +
    annotate(geom="text",x=as.Date("2020-08-05"), y=.11, label="Highest Risk (CDC)", color = "#ca562c", size=3) +
  theme_bw())

```

```{r}

ggplotly(ggplot(pct_positive_by_zip_complete, aes(x = date, y = POS_14_day_per_100000)) + 
  geom_line(aes(color = as.character(zip_code))) +
  xlab("") +
  ylab("New Positive Tests over 14 Days per 100,000") +
  ggtitle("New Positive Cases over 14 Days by ZIP per 100,000") +
  geom_hline(yintercept=.03, linetype="dashed", 
                color = "#008080", size=0.5) +
        annotate(geom="text",x=as.Date("2020-08-05"), y=.04, label="Lower risk (CDC)", color = "#008080", size=3) +
  geom_hline(yintercept=0.05, linetype="dashed", 
                color = "#b4c8a8", size=0.5) +
      annotate(geom="text",x=as.Date("2020-08-05"), y=.06, label="Moderate risk (CDC)", color = "#b4c8a8", size=3) +
  geom_hline(yintercept=0.08, linetype="dashed", 
                color = "#edbb8a", size=0.5) +
    annotate(geom="text",x=as.Date("2020-08-05"), y=.09, label="Higher risk (CDC)", color = "#edbb8a", size=3) +
  geom_hline(yintercept=0.10, linetype="dashed", 
                color = "#ca562c", size=0.5) +
    annotate(geom="text",x=as.Date("2020-08-05"), y=.11, label="Highest Risk (CDC)", color = "#ca562c", size=3) +
  geom_hline(yintercept=5, linetype="dashed", 
                color = "#008080", size=0.5) +
  annotate(geom="text",x=as.Date("2020-08-05"), y=10, label="Lower risk (CDC)", color = "#008080", size=3) +
  geom_hline(yintercept=20, linetype="dashed", 
                color = "#b4c8a8", size=0.5) +
       annotate(geom="text",x=as.Date("2020-08-05"), y=25, label="Moderate risk (CDC)", color = "#b4c8a8", size=3) +
  geom_hline(yintercept=50, linetype="dashed", 
                color = "#edbb8a", size=0.5) +
      annotate(geom="text",x=as.Date("2020-08-05"), y=55, label="Higher risk (CDC)", color = "#edbb8a", size=3) +
  geom_hline(yintercept=200, linetype="dashed", 
                color = "#ca562c", size=0.5) +
      annotate(geom="text",x=as.Date("2020-08-05"), y=205, label="Highest Risk (CDC)", color = "#ca562c", size=3) +
    theme_bw())
```




```{r philadelphia new positive tests per day by zip}

ggplotly(ggplot(pct_positive_by_zip_complete, aes(x = date, y = POS_new_7_mean)) + 
  geom_line(aes(color = as.character(zip_code))) +
  xlab("") +
  ylab("New Positive Tests Per Day per ZIP (7-day mean)") +
  ggtitle("New Positive Cases Per Day by ZIP (interpolated NA)") +
  geom_hline(yintercept=.03, linetype="dashed", 
                color = "#008080", size=0.5) +
        annotate(geom="text",x=as.Date("2020-08-05"), y=.04, label="Lower risk (CDC)", color = "#008080", size=3) +
  geom_hline(yintercept=0.05, linetype="dashed", 
                color = "#b4c8a8", size=0.5) +
      annotate(geom="text",x=as.Date("2020-08-05"), y=.06, label="Moderate risk (CDC)", color = "#b4c8a8", size=3) +
  geom_hline(yintercept=0.08, linetype="dashed", 
                color = "#edbb8a", size=0.5) +
    annotate(geom="text",x=as.Date("2020-08-05"), y=.09, label="Higher risk (CDC)", color = "#edbb8a", size=3) +
  geom_hline(yintercept=0.10, linetype="dashed", 
                color = "#ca562c", size=0.5) +
    annotate(geom="text",x=as.Date("2020-08-05"), y=.11, label="Highest Risk (CDC)", color = "#ca562c", size=3) +
  theme_bw())
```




```{r include = FALSE}

philadelphia_icu <- philadelphia %>% 
  filter(indicator=="icu_avail", date >= today() - days(14))

philadelphia_icu$date <- as.Date(philadelphia_icu$date)

past_date <- as.Date(today()-days(14))
future_date <- as.Date(today()+days(14))


phil_icu <- ggplot(philadelphia_icu, aes(x=date, y=number)) +
  geom_line() + 
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE) +
  scale_x_date(expand = c(0, 7)) +  
  labs(title="Philadelphia 14-Day ICU Availability Trend",
       y="ICU Beds Open",
       x="") +
    theme_bw()

lancaster_icu <- lancaster %>% 
  filter(indicator=="icu_avail", date >= today() - days(14))

lancaster_icu$date <- as.Date(lancaster_icu$date)

past_date <- as.Date(today()-days(14))
future_date <- as.Date(today()+days(14))


lanc_icu <- ggplot(lancaster_icu, aes(x=date, y=number)) +
  geom_line() + 
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE) +
  scale_x_date(expand = c(0, 7)) +  
  labs(title="Lancaster 14-Day ICU Availability Trend",
       y="ICU Beds Open",
       x="") +
    theme_bw()

phil_icu

```

```{r}
lanc_icu
```

